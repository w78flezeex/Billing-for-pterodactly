// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USERS ====================
model User {
  id              String    @id @default(cuid())
  email           String    @unique
  password        String
  name            String
  avatar          String?
  phone           String?
  company         String?
  role            Role      @default(USER)
  emailVerified   Boolean   @default(false)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastLoginAt     DateTime?
  
  // Billing info
  balance         Float     @default(0)
  
  // 2FA
  twoFactorSecret      String?
  twoFactorEnabled     Boolean   @default(false)
  twoFactorBackupCodes String[]  @default([])
  
  // Email verification & password reset
  emailVerifyToken       String?
  emailVerifyExpires     DateTime?
  resetPasswordToken     String?
  resetPasswordExpires   DateTime?
  isEmailVerified        Boolean   @default(false)
  isDeleted              Boolean   @default(false)
  
  // Referral system
  referralCode      String    @unique @default(cuid())
  referredById      String?
  referredBy        User?     @relation("Referrals", fields: [referredById], references: [id])
  referredUsers     User[]    @relation("Referrals")
  referralBalance   Float     @default(0)
  referralEarnings  Float     @default(0)
  
  // Notifications
  notifyEmail       Boolean   @default(true)
  notifyTelegram    Boolean   @default(false)
  telegramChatId    String?
  discordWebhook    String?
  
  // Relations
  sessions          Session[]
  orders            Order[]
  servers           Server[]
  invoices          Invoice[]
  tickets           Ticket[]
  transactions      Transaction[]
  promocodeUsages   PromocodeUsage[]
  loginHistory      LoginHistory[]
  notifications     Notification[]
  
  // New billing relations
  purchasedCertificates GiftCertificate[] @relation("PurchasedCertificates")
  redeemedCertificates  GiftCertificate[] @relation("RedeemedCertificates")
  withdrawalRequests    WithdrawalRequest[]
  spendingLimit         SpendingLimit?
  fraudAlerts           FraudAlert[]
  
  @@map("users")
}

enum Role {
  USER
  CLIENT
  SUPPORT
  MODERATOR
  ADMIN
}

// ==================== SESSIONS ====================
model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  userAgent String?
  ipAddress String?
  createdAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("sessions")
}

// ==================== LOGIN HISTORY ====================
model LoginHistory {
  id        String   @id @default(cuid())
  userId    String
  ipAddress String
  userAgent String?
  country   String?
  city      String?
  success   Boolean  @default(true)
  createdAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("login_history")
}

// ==================== TRANSACTIONS ====================
model Transaction {
  id            String          @id @default(cuid())
  userId        String
  type          TransactionType
  amount        Float
  balanceBefore Float
  balanceAfter  Float
  description   String?
  paymentMethod String?
  paymentId     String?
  status        PaymentStatus   @default(PENDING)
  metadata      Json?
  createdAt     DateTime        @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("transactions")
}

enum TransactionType {
  DEPOSIT       // Пополнение
  WITHDRAWAL    // Вывод
  PURCHASE      // Покупка
  REFUND        // Возврат
  REFERRAL      // Реферальный бонус
  PROMOCODE     // Промокод
  BONUS         // Бонус от админа
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

// ==================== PROMOCODES ====================
model Promocode {
  id            String          @id @default(cuid())
  code          String          @unique
  type          PromocodeType
  value         Float           // Сумма или процент
  minAmount     Float?          // Минимальная сумма заказа
  maxUses       Int?            // Максимум использований
  usedCount     Int             @default(0)
  maxUsesPerUser Int            @default(1)
  validFrom     DateTime        @default(now())
  validUntil    DateTime?
  isActive      Boolean         @default(true)
  planTypes     PlanType[]      // К каким типам планов применим
  createdAt     DateTime        @default(now())
  
  usages PromocodeUsage[]
  
  @@map("promocodes")
}

enum PromocodeType {
  FIXED       // Фиксированная сумма
  PERCENT     // Процент скидки
  BALANCE     // Бонус на баланс
}

model PromocodeUsage {
  id          String   @id @default(cuid())
  userId      String
  promocodeId String
  orderId     String?
  amount      Float    // Сколько сэкономил/получил
  createdAt   DateTime @default(now())
  
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  promocode Promocode @relation(fields: [promocodeId], references: [id], onDelete: Cascade)
  
  @@unique([userId, promocodeId])
  @@map("promocode_usages")
}

// ==================== LOCATIONS ====================
model Location {
  id          String   @id @default(cuid())
  name        String
  country     String
  city        String
  flag        String   // Эмодзи флага
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  
  // Pterodactyl
  pterodactylLocationId Int?
  
  servers Server[]
  plans   PlanLocation[]
  
  @@map("locations")
}

model PlanLocation {
  planId     String
  locationId String
  stock      Int      @default(-1) // -1 = unlimited
  
  plan     Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  
  @@id([planId, locationId])
  @@map("plan_locations")
}

// ==================== PLANS ====================
model Plan {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        PlanType
  price       Float
  priceYearly Float?   // Цена за год (со скидкой)
  period      Period   @default(MONTHLY)
  features    Json     // Array of features
  specs       Json     // RAM, CPU, Storage, etc.
  isActive    Boolean  @default(true)
  isPopular   Boolean  @default(false)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Pterodactyl
  pterodactylNestId Int?
  pterodactylEggId  Int?
  
  servers   Server[]
  orders    Order[]
  locations PlanLocation[]
  
  @@map("plans")
}

enum PlanType {
  GAME_HOSTING
  VPS
  WEB_HOSTING
  DEDICATED
}

enum Period {
  MONTHLY
  YEARLY
}

// ==================== SERVERS ====================
model Server {
  id          String       @id @default(cuid())
  userId      String
  planId      String
  locationId  String?
  name        String
  status      ServerStatus @default(PENDING)
  ipAddress   String?
  port        Int?
  expiresAt   DateTime
  autoRenew   Boolean      @default(true)
  suspendedAt DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  // Pterodactyl
  pterodactylServerId   Int?
  pterodactylIdentifier String?
  pterodactylUuid       String?
  
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan     Plan      @relation(fields: [planId], references: [id])
  location Location? @relation(fields: [locationId], references: [id])
  backups  Backup[]
  
  @@map("servers")
}

enum ServerStatus {
  PENDING
  INSTALLING
  ACTIVE
  SUSPENDED
  EXPIRED
  TERMINATED
}

// ==================== BACKUPS ====================
model Backup {
  id        String       @id @default(cuid())
  serverId  String
  name      String
  size      BigInt       @default(0)
  status    BackupStatus @default(PENDING)
  completedAt DateTime?
  createdAt DateTime     @default(now())
  
  // Pterodactyl
  pterodactylBackupUuid String?
  
  server Server @relation(fields: [serverId], references: [id], onDelete: Cascade)
  
  @@map("backups")
}

enum BackupStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  DELETED
}

// ==================== ORDERS ====================
model Order {
  id            String      @id @default(cuid())
  userId        String
  planId        String
  amount        Float
  discount      Float       @default(0)
  promocodeId   String?
  status        OrderStatus @default(PENDING)
  paymentMethod String?
  paymentId     String?
  period        Period      @default(MONTHLY)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan Plan @relation(fields: [planId], references: [id])
  
  @@map("orders")
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  COMPLETED
  CANCELLED
  REFUNDED
}

// ==================== INVOICES ====================
model Invoice {
  id          String        @id @default(cuid())
  number      String        @unique // INV-2026-0001
  userId      String
  amount      Float
  tax         Float         @default(0)
  status      InvoiceStatus @default(UNPAID)
  description String?
  items       Json          // Массив позиций
  dueDate     DateTime
  paidAt      DateTime?
  pdfUrl      String?
  createdAt   DateTime      @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("invoices")
}

enum InvoiceStatus {
  UNPAID
  PAID
  OVERDUE
  CANCELLED
}

// ==================== TICKETS ====================
model Ticket {
  id         String       @id @default(cuid())
  userId     String
  subject    String
  status     TicketStatus @default(OPEN)
  priority   Priority     @default(NORMAL)
  category   String?
  serverId   String?      // Привязка к серверу
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  closedAt   DateTime?
  
  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages TicketMessage[]
  
  @@map("tickets")
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING
  CLOSED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model TicketMessage {
  id          String   @id @default(cuid())
  ticketId    String
  userId      String?  // null = система
  content     String
  isStaff     Boolean  @default(false)
  staffName   String?  // Имя сотрудника поддержки
  attachments Json?    // URLs файлов
  createdAt   DateTime @default(now())
  
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  @@map("ticket_messages")
}

// ==================== NOTIFICATIONS ====================
model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("notifications")
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  PAYMENT
  SERVER
  TICKET
  PROMO
}

// ==================== FAQ / KNOWLEDGE BASE ====================
model FaqCategory {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  icon      String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  
  articles FaqArticle[]
  
  @@map("faq_categories")
}

model FaqArticle {
  id         String   @id @default(cuid())
  categoryId String
  title      String
  slug       String   @unique
  content    String   // Markdown
  views      Int      @default(0)
  isPublished Boolean @default(true)
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  category FaqCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@map("faq_articles")
}

// ==================== SERVER STATUS / INCIDENTS ====================
model ServerNode {
  id          String     @id @default(cuid())
  name        String
  locationId  String?
  status      NodeStatus @default(ONLINE)
  lastCheckAt DateTime   @default(now())
  uptime      Float      @default(100)
  
  incidents Incident[]
  
  @@map("server_nodes")
}

enum NodeStatus {
  ONLINE
  DEGRADED
  MAINTENANCE
  OFFLINE
}

model Incident {
  id          String         @id @default(cuid())
  nodeId      String?
  title       String
  description String
  status      IncidentStatus @default(INVESTIGATING)
  severity    Severity       @default(MINOR)
  startedAt   DateTime       @default(now())
  resolvedAt  DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  node    ServerNode?      @relation(fields: [nodeId], references: [id])
  updates IncidentUpdate[]
  
  @@map("incidents")
}

enum IncidentStatus {
  INVESTIGATING
  IDENTIFIED
  MONITORING
  RESOLVED
}

enum Severity {
  MINOR
  MAJOR
  CRITICAL
}

model IncidentUpdate {
  id         String   @id @default(cuid())
  incidentId String
  message    String
  createdAt  DateTime @default(now())
  
  incident Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  
  @@map("incident_updates")
}

// ==================== ADMIN LOGS ====================
model AdminLog {
  id        String   @id @default(cuid())
  adminId   String
  action    String
  target    String?  // user:123, server:456
  details   Json?
  ipAddress String?
  createdAt DateTime @default(now())
  
  @@map("admin_logs")
}

// ==================== SETTINGS ====================
model Setting {
  key       String   @id
  value     Json
  updatedAt DateTime @updatedAt
  
  @@map("settings")
}

// ==================== GIFT CERTIFICATES ====================
model GiftCertificate {
  id            String              @id @default(cuid())
  code          String              @unique
  amount        Float               // Номинал
  balance       Float               // Остаток (можно частично использовать)
  purchasedById String?             // Кто купил
  purchasedBy   User?               @relation("PurchasedCertificates", fields: [purchasedById], references: [id])
  redeemedById  String?             // Кто активировал
  redeemedBy    User?               @relation("RedeemedCertificates", fields: [redeemedById], references: [id])
  redeemedAt    DateTime?
  expiresAt     DateTime?
  isActive      Boolean             @default(true)
  message       String?             // Сообщение получателю
  recipientEmail String?            // Email получателя для отправки
  createdAt     DateTime            @default(now())
  
  @@map("gift_certificates")
}

// ==================== WITHDRAWAL REQUESTS ====================
model WithdrawalRequest {
  id            String              @id @default(cuid())
  userId        String
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount        Float
  method        WithdrawalMethod
  details       Json                // Реквизиты (карта, кошелёк и т.д.)
  status        WithdrawalStatus    @default(PENDING)
  adminNote     String?
  processedById String?
  processedAt   DateTime?
  createdAt     DateTime            @default(now())
  
  @@map("withdrawal_requests")
}

enum WithdrawalMethod {
  CARD          // Банковская карта
  YOOMONEY      // ЮMoney
  QIWI          // QIWI
  CRYPTO        // Криптовалюта
}

enum WithdrawalStatus {
  PENDING       // Ожидает
  PROCESSING    // В обработке
  COMPLETED     // Выполнено
  REJECTED      // Отклонено
}

// ==================== SPENDING LIMITS ====================
model SpendingLimit {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  monthlyLimit  Float?    // Месячный лимит
  dailyLimit    Float?    // Дневной лимит
  isEnabled     Boolean   @default(true)
  alertAt       Float?    // Уведомить при достижении % от лимита
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("spending_limits")
}

// ==================== FRAUD DETECTION ====================
model FraudAlert {
  id            String        @id @default(cuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          FraudType
  severity      FraudSeverity
  description   String
  metadata      Json?         // Дополнительные данные
  status        FraudStatus   @default(PENDING)
  reviewedById  String?
  reviewedAt    DateTime?
  reviewNote    String?
  createdAt     DateTime      @default(now())
  
  @@map("fraud_alerts")
}

enum FraudType {
  MULTIPLE_ACCOUNTS     // Множественные аккаунты
  SUSPICIOUS_PAYMENT    // Подозрительный платёж
  UNUSUAL_ACTIVITY      // Необычная активность
  CHARGEBACK            // Чарджбэк
  IP_MISMATCH           // Несоответствие IP
  VELOCITY              // Слишком много транзакций
}

enum FraudSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum FraudStatus {
  PENDING       // Ожидает проверки
  INVESTIGATING // В расследовании
  CONFIRMED     // Подтверждено
  FALSE_POSITIVE // Ложное срабатывание
  RESOLVED      // Решено
}

// ==================== BALANCE GIFTS ====================
model BalanceGift {
  id            String      @id @default(cuid())
  senderId      String
  recipientId   String?     // null если по email/username
  recipientEmail String?
  amount        Float
  message       String?
  status        GiftStatus  @default(PENDING)
  claimedAt     DateTime?
  expiresAt     DateTime?
  createdAt     DateTime    @default(now())
  
  @@map("balance_gifts")
}

enum GiftStatus {
  PENDING       // Ожидает получения
  CLAIMED       // Получен
  EXPIRED       // Истёк
  CANCELLED     // Отменён
}

// ==================== VOLUME DISCOUNTS ====================
model VolumeDiscount {
  id            String   @id @default(cuid())
  name          String
  minAmount     Float    // Минимальная сумма пополнений
  discountPercent Float  // Процент скидки
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  
  @@map("volume_discounts")
}

model UserDiscount {
  id            String   @id @default(cuid())
  userId        String
  discountPercent Float  // Персональная скидка
  totalSpent    Float    @default(0) // Общая сумма потраченных денег
  discountTier  String?  // Уровень скидки (Bronze, Silver, Gold, Platinum)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([userId])
  @@map("user_discounts")
}

// ==================== AUTO RENEWAL ====================
model AutoRenewal {
  id            String   @id @default(cuid())
  userId        String
  serverId      String
  isEnabled     Boolean  @default(true)
  daysBeforeExpiry Int   @default(3) // За сколько дней до истечения продлевать
  renewalPeriod Int      @default(30) // На сколько дней продлевать
  lastRenewalAt DateTime?
  nextRenewalAt DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([userId, serverId])
  @@map("auto_renewals")
}

// ==================== WEBHOOKS ====================
model Webhook {
  id            String        @id @default(cuid())
  userId        String
  name          String
  url           String
  secret        String?       // HMAC секрет для подписи
  events        WebhookEvent[]
  isActive      Boolean       @default(true)
  lastTriggeredAt DateTime?
  failCount     Int           @default(0)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  logs WebhookLog[]
  
  @@map("webhooks")
}

model WebhookLog {
  id            String   @id @default(cuid())
  webhookId     String
  event         WebhookEvent
  payload       Json
  responseCode  Int?
  responseBody  String?
  success       Boolean
  executedAt    DateTime @default(now())
  
  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  
  @@map("webhook_logs")
}

enum WebhookEvent {
  SERVER_CREATED
  SERVER_DELETED
  SERVER_EXPIRED
  SERVER_RENEWED
  PAYMENT_COMPLETED
  PAYMENT_FAILED
  BALANCE_LOW
  TICKET_CREATED
  TICKET_REPLIED
}

// ==================== EMAIL CAMPAIGNS ====================
model EmailCampaign {
  id            String         @id @default(cuid())
  name          String
  subject       String
  content       String         @db.Text
  targetType    EmailTarget
  targetFilter  Json?          // Фильтры для выбора получателей
  sentCount     Int            @default(0)
  openCount     Int            @default(0)
  clickCount    Int            @default(0)
  status        CampaignStatus @default(DRAFT)
  scheduledAt   DateTime?
  sentAt        DateTime?
  createdById   String
  createdAt     DateTime       @default(now())
  
  @@map("email_campaigns")
}

enum EmailTarget {
  ALL_USERS
  ACTIVE_USERS
  INACTIVE_USERS
  WITH_SERVERS
  WITHOUT_SERVERS
  CUSTOM
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  CANCELLED
}

// ==================== AUDIT LOG ====================
model AuditLog {
  id            String   @id @default(cuid())
  userId        String?
  userEmail     String?
  action        String
  entityType    String?  // User, Server, Payment, etc.
  entityId      String?
  oldValue      Json?
  newValue      Json?
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())
  
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ==================== TELEGRAM BOT ====================
model TelegramUser {
  id            String   @id @default(cuid())
  userId        String   @unique
  chatId        String   @unique
  username      String?
  isVerified    Boolean  @default(false)
  verifyCode    String?
  notifyPayments Boolean @default(true)
  notifyServers Boolean  @default(true)
  notifyTickets Boolean  @default(true)
  createdAt     DateTime @default(now())
  
  @@map("telegram_users")
}

// ==================== DISCORD CONNECTIONS ====================
model DiscordConnection {
  id            String   @id @default(cuid())
  userId        String   @unique
  discordId     String   @unique
  username      String
  discriminator String?
  avatar        String?
  accessToken   String?
  refreshToken  String?
  expiresAt     DateTime?
  createdAt     DateTime @default(now())
  
  @@map("discord_connections")
}

// ==================== INTEGRATIONS SETTINGS (ADMIN) ====================
model IntegrationSetting {
  id            String   @id @default(cuid())
  key           String   @unique
  value         String   @db.Text
  isEncrypted   Boolean  @default(false)
  description   String?
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())
  
  @@map("integration_settings")
}
